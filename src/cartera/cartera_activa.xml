<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="cartera_activa.xml" /> 
  <Content type="html">
	<![CDATA[
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		<style>
			.header_hide_style {
				display: none;
			}
			.header_style {
					height: 35px;
					background-color: #009EE5;
					border-right: 0.5px solid #FFFFFF;
					/*border-right: 1px solid #FFFFFF;*/
					/*display: none;*/
					color: white;
					font-weight: bold;
					text-align: center;
			}
			.filtros_style {
					color: #094FA4;
					font-family: Arial, sans-serif;
					font-weight: bold;
					font-size: 13px;
			}
			.cell_style {
					height: 35px;
					border-bottom: 1px solid #D9D9D9;
					/*border-left: 1px solid #D9D9D9;*/
					background-color: #FFFFFF;
					text-align: center;
			}
			.cell_left_style {
					height: 35px;
					/*border-left: 1px solid #D9D9D9;*/
					border-bottom: 1px solid #D9D9D9;
					/*border-right: 1px solid #D9D9D9;*/
					background-color: #FFFFFF;
					text-align: left;
			}
			.cell_warning_style {
					height: 35px;
					border-bottom: 1px solid #D9D9D9;
					background-color: #dd7e6b;
					text-align: center;	
					color: #000000;
			}
      .cell_warning_info_style {
          height: 35px;
					border-bottom: 1px solid #D9D9D9;
					background-color: #FFD966;
					text-align: center;	
					color: #000000;
      }
			.cell_width_200 {
					width: 200px;
			}
			.cell_width_120 {
					width: 120px;
			}
			.cell_width_100 {
					width: 100px;
			}
			.cell_width_70 {
					width: 70px;
			}
			.cell_width_60 {
					width: 60px;
			}
			.bold_style {
					font-weight: bold;
			}
		</style>
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<script src="https://site-itam.googlecode.com/svn/branches/lib/jquery-1.10.2.min.js"></script>
		<link href="https://site-itam.googlecode.com/svn/branches/lib/perfect-scrollbar.css" rel="stylesheet">
		<script src="https://site-itam.googlecode.com/svn/branches/lib/jquery.mousewheel.js"></script>
		<script src="https://site-itam.googlecode.com/svn/branches/lib/perfect-scrollbar.js"></script>
		<script type="text/javascript">
			google.load('visualization', '1.1', {packages: ['controls','table']});
			google.setOnLoadCallback(draw);

			function draw() {
				$('#contenido_tabla').perfectScrollbar({
						  wheelSpeed: 20,
						  wheelPropagation: false
						});
				var query = new google.visualization.Query('https://docs.google.com/a/bbva.com/spreadsheet/ccc?key=0AuL8XqqgbAI4dGp4Q0dlSXh2X29qeVhJWm9ha2hDaEE&usp=drive_web#gid=0');
				query.send(handleQueryResponse);
				
			}
			
			function handleQueryResponse(response) {
				if (response.isError()) {
					alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
					return;
				}
				var data = response.getDataTable();
				var category_anio = new google.visualization.ControlWrapper({
										'controlType': 'CategoryFilter',
										'containerId': 'filtro1',
										'options': {
												'filterColumnLabel': 'AÑO',
														'ui': {
																'labelSeparator' : '',
																'label' : '',
																'caption' : 'Selecciona un valor',
																'allowMultiple': true,
																'allowTyping': false,
																'selectedValuesLayout': 'aside'
														}
										}
									});
				
				var category_estado = new google.visualization.ControlWrapper({
										'controlType': 'CategoryFilter',
										'containerId': 'filtro2',
										'options': {
												'filterColumnLabel': 'ESTADO',
														'ui': {
																'labelSeparator' : '',
																'label' : '',
																'caption' : 'Selecciona un valor',
																'allowMultiple': true,
																'allowTyping': false,
																'selectedValuesLayout': 'aside'
														}
										}
									});
				
				var category_fase = new google.visualization.ControlWrapper({
										'controlType': 'CategoryFilter',
										'containerId': 'filtro3',
										'options': {
												'filterColumnLabel': 'FASE ACTUAL',
														'ui': {
																'labelSeparator' : '',
																'label' : '',
																'caption' : 'Selecciona un valor',
																'allowMultiple': true,
																'allowTyping': false,
																'selectedValuesLayout': 'aside'
														}
										}
									});
				
				var cssClassNames = {
					'headerRow': 'header_hide_style',
					'tableCell': 'cell_style'
				};
				
				var options = {'allowHtml': true, 'cssClassNames': cssClassNames, 'sort': 'disable', 'height': '100%', 'width': '100%'};
				
				var table = new google.visualization.ChartWrapper({
								'chartType': 'Table',
								'containerId': 'table',
								'options': options
							});
				
				var formatter_link = new google.visualization.PatternFormat('<a href="{11}" target="_blank">{0}</a>');
				formatter_link.format(data, [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);
				
				var formatter_fecha = new google.visualization.DateFormat({pattern: 'dd-MMM-yy'});
				formatter_fecha.format(data, 8);
				
				var column_nombre = 1;
				var column_anio = 3;
				var column_lider = 5;
				var column_estado = 6;
				var column_fase = 7;
				var column_finfase = 8;
				var column_area = 11;
				var stilo;
				var fecha_actual = new Date();
				fecha_actual = new Date(fecha_actual.getFullYear(), fecha_actual.getMonth(), fecha_actual.getDate());
				
				for (var row = 0; row < data.getNumberOfRows(); row++) {
					data.setCell(row, column_nombre, data.getValue(row, column_nombre), data.getFormattedValue(row, column_nombre), {'className': 'cell_left_style'});
					data.setCell(row, column_anio, data.getValue(row, column_anio), data.getFormattedValue(row, column_anio), {'className': 'cell_style bold_style cell_width_60'});
					data.setCell(row, column_lider, data.getValue(row, column_lider), data.getFormattedValue(row, column_lider), {'className': 'cell_style cell_width_120'});
					data.setCell(row, column_estado, data.getValue(row, column_estado), data.getFormattedValue(row, column_estado), {'className': 'cell_style bold_style cell_width_100'});
					data.setCell(row, column_fase, data.getValue(row, column_fase), data.getFormattedValue(row, column_fase), {'className': 'cell_style bold_style cell_width_120'});

					stilo = 'cell_style bold_style cell_width_70';
					if ((data.getValue(row, column_estado)).toLowerCase().indexOf('terminado') == -1 && data.getValue(row, column_finfase) < fecha_actual) {
						stilo = 'cell_warning_style bold_style cell_width_70';
					} else {
 
            if (data.getValue(row, column_finfase) >= fecha_actual
                && ((((data.getValue(row, column_finfase)-fecha_actual)/1000)/60)/60)/24 <= 7) {
                  stilo = 'cell_warning_info_style bold_style cell_width_70';
                }
   
          }
					data.setCell(row, column_finfase, data.getValue(row, column_finfase), data.getFormattedValue(row, column_finfase), {'className': stilo});
					data.setCell(row, column_area, data.getValue(row, column_area), data.getFormattedValue(row, column_area), {'className': 'cell_style cell_width_100'});
					
				}
				
				var view = new google.visualization.DataView(data);
				view.setColumns([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]);
				
				new google.visualization.Dashboard(document.getElementById('dashboard')).
						bind([category_anio, category_estado, category_fase], table).
						draw(view);

				google.visualization.events.addListener(table, 'ready',
					function(event) {
						//if ($("#table").height() >= 500) {
							//$("#headers_table").width($("#headers_table").width() - 3);
						//}
						
						$("#table table tbody tr:last-child td").each(function(index){
							if ($("#w"+(index+1)).val() > $(this).width()) {
								$(this).width($("#w"+(index+1)).val());
								$("#h"+(index+1)).width($("#w"+(index+1)).val());
							} else {
								$("#h"+(index+1)).width($(this).width());
							}

						});
						$("#table table tbody tr:last-child td").each(function(index){
							$("#h"+(index+1)).width($(this).width());
						});
						$("#contenido_tabla").scrollTop(0);
						
				});
				
			}

		</script>
		<div id="dashboard">
			<table width="100%">
				<tr>
					<td width="5%" height="50px" style="text-align:right;" class="filtros_style">Año:</td>
					<td width="20%" height="50px" class="filtros_style"><div id="filtro1"></div></td>
					<td width="5%" height="50px" style="text-align:right;" class="filtros_style">Estado:</td>
					<td width="20%" height="50px" class="filtros_style"><div id="filtro2"></div></td>
					<td width="8%" height="50px" style="text-align:right;" class="filtros_style">Fase Actual:</td>
					<td width="42%" height="50px" class="filtros_style"><div id="filtro3"></div></td>
				</tr>
				<tr>
					<td colspan="6">
						<table id="headers_table"  width="100%" height="35px" class="filtros_style">
							<tr>
								<td id="h1" class="header_style"><input id="w1" type="hidden" value="56"/>NOMBRE</td>
								<td id="h2" class="header_style"><input id="w2" type="hidden" value="31"/>TIPO</td>
								<td id="h3" class="header_style"><input id="w3" type="hidden" value="28"/>AÑO</td>
								<td id="h4" class="header_style"><input id="w4" type="hidden" value="71"/>FIN PROYECTO</td>
								<td id="h5" class="header_style"><input id="w5" type="hidden" value="38"/>LÍDER</td>
								<td id="h6" class="header_style"><input id="w6" type="hidden" value="53"/>ESTADO</td>
								<td id="h7" class="header_style"><input id="w7" type="hidden" value="49"/>FASE ACTUAL</td>
								<td id="h8" class="header_style"><input id="w8" type="hidden" value="34"/>FIN FASE</td>
								<td id="h9" class="header_style"><input id="w9" type="hidden" value="55"/>Ppto EST(usd)</td>
								<td id="h10" class="header_style"><input id="w10" type="hidden" value="70"/>CHAMPION</td>
								<td id="h11" class="header_style"><input id="w11" type="hidden" value="35"/>ÁREA</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<div id="contenido_tabla" style="height:500px;overflow:hidden;position:relative;">
				<table width="100%">
					<tr>
						<td><div id="table"></div></td>
					</tr>
				</table>
			</div>
		</div>
	]]>
  </Content> 
</Module>